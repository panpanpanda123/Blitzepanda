from sqlalchemy import create_engine
import sqlalchemy.types as sqltypes
from sqlalchemy.types import Integer, Float, String, Date
from sqlalchemy import JSON, Integer

# ✅ 通用函数（传入 if_exists 控制 replace/append）
def import_to_mysql(df, table_name, db_connection_string, dtype=None, if_exists='append'):
    engine = create_engine(db_connection_string)
    try:
        df.to_sql(
            name=table_name,
            con=engine,
            if_exists=if_exists,
            index=False,
            dtype=dtype
        )
        print(f"✅ 数据成功导入表：{table_name}，模式：{if_exists}")
    except Exception as e:
        print(f"❌ 数据导入表 {table_name} 失败: {e}")
        raise

def get_dtype_for_cpc_hourly(df):
    dtype_mapping = {
        'date': sqltypes.Date,
        'start_time': sqltypes.DateTime(),
        'time_slot': sqltypes.String(50),
        'cost': sqltypes.Float,
        'impressions': sqltypes.Integer,
        'clicks': sqltypes.Integer,
        'avg_cpc': sqltypes.Float,
        'view_images': sqltypes.Integer,
        'view_reviews': sqltypes.Integer,
        'view_address': sqltypes.Integer,
        'favorites': sqltypes.Integer,
        'shares': sqltypes.Integer,
        'orders': sqltypes.Integer,
        'merchant_views': sqltypes.Integer,
        'interests': sqltypes.Integer,
        'view_groupbuy': sqltypes.Integer,  # 可选字段
          # —— 新增字段 ——
        'cash_spent': sqltypes.Float,
        'view_phone': sqltypes.Integer,
        'view_recommended_dishes': sqltypes.Integer,
        'promo_claims': sqltypes.Integer,
        'group_orders': sqltypes.Integer,
        'flash_orders': sqltypes.Integer,
        'store_city': sqltypes.String(100),
    }
    return {col: dtype_mapping[col] for col in df.columns if col in dtype_mapping}

def get_dtype_for_operation(df):
    dtype_mapping = {
        '日期': Date,
        '美团门店ID': Integer,
        '门店名称': String(255),
        '城市': String(255),
        '曝光次数': Integer,
        '曝光次数-搜索': Integer,
        '曝光次数-美食频道': Integer,
        '曝光次数-首页信息流': Integer,
        '曝光人数': Integer,
        '曝光人数-搜索': Integer,
        '曝光人数-美食频道': Integer,
        '曝光人数-首页信息流': Integer,
        '访问次数': Integer,
        '访问次数-搜索': Integer,
        '访问次数-美食频道': Integer,
        '访问次数-首页信息流': Integer,
        '访问人数': Integer,
        '访问人数-搜索': Integer,
        '访问人数-美食频道': Integer,
        '访问人数-首页信息流': Integer,
        '曝光-访问转化率': Float,
        '曝光-访问转化率-搜索': Float,
        '曝光-访问转化率-美食频道': Float,
        '曝光-访问转化率-首页信息流': Float,
        '购买人数': Integer,
        '购买人数-搜索': Integer,
        '购买人数-美食频道': Integer,
        '购买人数-首页信息流': Integer,
        '访问-购买转化率': Float,
        '访问-购买转化率-搜索': Float,
        '访问-购买转化率-美食频道': Float,
        '访问-购买转化率-首页信息流': Float,
        '互动人数': Integer,
        '新增收藏人数': Integer,
        '累计收藏人数': Integer,
        '打卡人数': Integer,
        '查看优惠人数': Integer,
        '查看菜品人数': Integer,
        '查看评价人数': Integer,
        '查看地址/电话人数': Integer,
        '成交金额(优惠前)': Integer,
        '成交金额(优惠前)-套餐': Integer,
        '成交金额(优惠前)-代金券': Integer,
        '成交金额(优惠前)-买单': Integer,
        '成交金额(优惠前)-秒提': Float,
        '成交订单数': Integer,
        '成交订单数-套餐': Integer,
        '成交订单数-代金券': Integer,
        '成交订单数-买单': Integer,
        '成交订单数-秒提': Float,
        '成交券数-套餐': Integer,
        '成交券数-代金券': Integer,
        '成交人数': Integer,
        '成交人数-套餐': Integer,
        '成交人数-代金券': Integer,
        '成交人数-买单': Integer,
        '成交人数-秒提': Float,
        '成交券单价(优惠前)-套餐': Integer,
        '成交券单价(优惠前)-代金券': Integer,
        '单均价(优惠前)': Float,
        '单均价(优惠前)-套餐': Float,
        '单均价(优惠前)-代金券': Float,
        '单均价(优惠前)-买单': Float,
        '单均价(优惠前)-秒提': Float,
        '成交客单价(优惠前)': Float,
        '成交金额(优惠后)': Integer,
        '成交金额(优惠后)-套餐': Integer,
        '成交金额(优惠后)-代金券': Integer,
        '成交金额(优惠后)-买单': Integer,
        '成交金额(优惠后)-秒提': Float,
        '成交券单价(优惠后)-套餐': Integer,
        '成交券单价(优惠后)-代金券': Integer,
        '单均价(优惠后)': Float,
        '单均价(优惠后)-套餐': Float,
        '单均价(优惠后)-代金券': Float,
        '单均价(优惠后)-买单': Float,
        '单均价(优惠后)-秒提': Float,
        '成交客单价(优惠后)': Float,
        '用户实付金额': Float,
        '用户实付金额-套餐': Integer,
        '用户实付金额-代金券': Float,
        '用户实付金额-买单': Float,
        '用户实付金额-秒提': Float,
        '平台补贴金额': Float,
        '平台补贴金额-套餐': Integer,
        '平台补贴金额-代金券': Float,
        '平台补贴金额-买单': Float,
        '平台补贴金额-秒提': Float,
        '团购核销金额-买单': Integer,
        '团购核销金额-秒提': Float,
        '支付金额-买单': Integer,
        '在线点单金额-秒提': Float,
        '团购核销券数-买单': Integer,
        '团购核销券数-秒提': Float,
        '团购核销金额占比-买单': Float,
        '团购核销金额占比-秒提': Float,
        '消费金额': Integer,
        '核销金额-套餐': Integer,
        '核销金额-代金券': Integer,
        '消费笔数': Integer,
        '核销券数-套餐': Integer,
        '核销券数-代金券': Integer,
        '消费人数': Integer,
        '核销人数-套餐': Integer,
        '核销人数-代金券': Integer,
        '消费笔单价': Integer,
        '核销券单价-套餐': Integer,
        '核销券单价-代金券': Integer,
        '退款金额': Integer,
        '退款金额-套餐': Integer,
        '退款金额-代金券': Integer,
        '退款金额-买单': Integer,
        '退款金额-秒提': Float,
        '退款券数-套餐': Integer,
        '退款券数-代金券': Integer,
        '撤销核销金额-套餐': Integer,
        '撤销核销金额-代金券': Integer,
        '撤销核销券数-套餐': Integer,
        '撤销核销券数-代金券': Integer,
        '退款订单数': Integer,
        '退款订单数-买单': Integer,
        '退款订单数-秒提': Float,
        '新客购买人数': Integer,
        '老客购买人数': Integer,
        '新客成交金额(优惠后)': Integer,
        '老客成交金额(优惠后)': Integer,
        '新客成交客单价(优惠后)': Float,
        '老客成交客单价(优惠后)': Float,
        '扫码人数': Integer,
        '扫码打卡人数': Integer,
        '扫码收藏人数': Integer,
        '扫码评价人数': Integer,
        '商品曝光次数-搜索': Integer,
        '商品曝光次数-美食频道': Integer,
        '商品曝光次数-首页信息流': Integer,
        '商品曝光次数-特价团': Integer,
        '商品曝光次数-直播': Integer,
        '商品曝光次数-团购频道': Integer,
        '商品曝光人数-搜索': Integer,
        '商品曝光人数-美食频道': Integer,
        '商品曝光人数-首页信息流': Integer,
        '商品曝光人数-特价团': Integer,
        '商品曝光人数-直播': Integer,
        '商品曝光人数-团购频道': Integer,
        '商品访问次数': Integer,
        '商品访问次数-搜索': Integer,
        '商品访问次数-美食频道': Integer,
        '商品访问次数-首页信息流': Integer,
        '商品访问次数-特价团': Integer,
        '商品访问次数-美团联盟': Integer,
        '商品访问次数-直播': Integer,
        '商品访问次数-团购频道': Integer,
        '商品访问人数': Integer,
        '商品访问人数-搜索': Integer,
        '商品访问人数-美食频道': Integer,
        '商品访问人数-首页信息流': Integer,
        '商品访问人数-特价团': Integer,
        '商品访问人数-美团联盟': Integer,
        '商品访问人数-直播': Integer,
        '商品访问人数-团购频道': Integer,
        '商品曝光-访问转化率-搜索': Float,
        '商品曝光-访问转化率-美食频道': Float,
        '商品曝光-访问转化率-首页信息流': Float,
        '商品曝光-访问转化率-特价团': Float,
        '商品曝光-访问转化率-直播': Float,
        '商品曝光-访问转化率-团购频道': Float,
        '商品购买人数': Integer,
        '商品购买人数-搜索': Integer,
        '商品购买人数-美食频道': Integer,
        '商品购买人数-首页信息流': Integer,
        '商品购买人数-特价团': Integer,
        '商品购买人数-美团联盟': Integer,
        '商品购买人数-直播': Integer,
        '商品购买人数-团购频道': Integer,
        '商品成交券数': Integer,
        '商品成交券数-搜索': Integer,
        '商品成交券数-美食频道': Integer,
        '商品成交券数-首页信息流': Integer,
        '商品成交券数-特价团': Integer,
        '商品成交券数-美团联盟': Integer,
        '商品成交券数-直播': Integer,
        '商品成交券数-团购频道': Integer,
        '商品访问-购买转化率': Float,
        '商品访问-购买转化率-搜索': Float,
        '商品访问-购买转化率-美食频道': Float,
        '商品访问-购买转化率-首页信息流': Float,
        '商品访问-购买转化率-特价团': Float,
        '商品访问-购买转化率-美团联盟': String(255),
        '商品访问-购买转化率-直播': Float,
        '商品访问-购买转化率-团购频道': Float,
        '商品成交金额(优惠前)': Integer,
        '商品成交金额(优惠后)': Integer,
        '商品成交金额(优惠后)-搜索': Integer,
        '商品成交金额(优惠后)-美食频道': Integer,
        '商品成交金额(优惠后)-首页信息流': Integer,
        '商品成交金额(优惠后)-特价团': Integer,
        '商品成交金额(优惠后)-美团联盟': Integer,
        '商品成交金额(优惠后)-直播': Integer,
        '商品成交金额(优惠后)-团购频道': Integer,
        '商品平台补贴金额': Float,
        '商品新客购买人数占比': Float,
        '商品核销券数': Integer,
        '商品核销券数-搜索': Integer,
        '商品核销券数-美食频道': Integer,
        '商品核销券数-首页信息流': Integer,
        '商品核销券数-特价团': Integer,
        '商品核销券数-美团联盟': Integer,
        '商品核销券数-直播': Integer,
        '商品核销券数-团购频道': Integer,
        '商品核销人数': Integer,
        '商品核销金额': Integer,
        '商品核销金额-搜索': Integer,
        '商品核销金额-美食频道': Integer,
        '商品核销金额-首页信息流': Integer,
        '商品核销金额-特价团': Integer,
        '商品核销金额-美团联盟': Integer,
        '商品核销金额-直播': Integer,
        '商品核销金额-团购频道': Integer,
        '商品撤销核销券数': Integer,
        '商品撤销核销人数': Integer,
        '商品撤销核销金额': Integer,
        '商品退款券数': Integer,
        '商品退款人数': Integer,
        '商品退款金额': Integer,
        '美团星级': Float,
        '美团口味分': Float,
        '美团服务分': Float,
        '美团性价比分': Float,
        '美团环境分': Float,
        '点评星级': Float,
        '点评口味分': Float,
        '点评服务分': Float,
        '点评食材分': Integer,
        '点评环境分': Float,
        '全部评价数': Integer,
        '全部好评数': Integer,
        '好评率': Float,
        '全部中差评数': Integer,
        '新评价数': Integer,
        '新好评数': Integer,
        '新中差评数': Integer,
        '新中差评回复率': Float,
        'ros_score': Integer,
        'rankings_detail': JSON,
    }
    return {col: dtype_mapping[col] for col in df.columns if col in dtype_mapping}
    print(f"✅ 数据成功导入表：{table_name}")
