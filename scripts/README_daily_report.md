# 日报生成脚本使用说明

## 概述

`generate_daily_report.py` 是一个自动生成日报的脚本，能够从数据库中提取运营数据，分析关键指标，并生成按运营师分组的日报文件。

## 功能特点

- **自动数据提取**: 从MySQL数据库自动拉取运营数据和CPC数据
- **智能环比分析**: 自动计算与上周同期的环比变化
- **榜单信息解析**: 解析并展示各平台的榜单排名
- **按运营师分组**: 自动按运营师分组生成报告
- **异常检测**: 自动检测数据异常并给出预警提示
- **数据价值分析**: 自动分析品牌表现并给出洞察建议
- **Excel数据文件**: 生成包含完整月度数据的Excel文件，支持专业样式

## 使用方法

### 基本用法

```bash
# 生成昨天的日报（默认）
python scripts/generate_daily_report.py

# 生成指定日期的日报
python scripts/generate_daily_report.py 2025-07-31
```

### 输出文件

脚本会在 `output/` 目录下生成以下文件：

#### 文本报告
- `{运营师名}_{日期}.txt` - 按运营师分组的日报文件

#### Excel数据文件
- `{运营师名}_{日期}_月度数据.xlsx` - 包含当月完整数据的Excel文件，每个门店一个sheet

Excel文件特点：
- **多sheet结构**: 每个门店一个工作表
- **完整数据**: 包含日期、星期、消费金额、推广通花费、曝光人数、访问人数、购买人数、转化率等
- **专业样式**: 表头加粗居中、冻结窗格、自适应列宽、数字格式设置
- **数据排序**: 按日期排序，便于查看趋势

例如：
- `pan_2025-07-31.txt` 和 `pan_2025-07-31_月度数据.xlsx`
- `cici_2025-07-31.txt` 和 `cici_2025-07-31_月度数据.xlsx`
- `dou_2025-07-31.txt` 和 `dou_2025-07-31_月度数据.xlsx`

## 报告内容

每个品牌的报告包含以下信息：

### 核心指标
- **消费金额**: 当日消费总额及环比
- **打卡人数**: 当日打卡人数及环比
- **收藏人数**: 新增收藏人数及环比
- **好评数**: 新好评数及环比
- **差评数**: 新中差评数及环比（如有）

### 排行榜信息
- 点评热门榜排名
- 点评打卡人气榜排名
- 点评好评榜排名

### 建议
- 根据数据情况给出运营建议
- 如有差评会自动提示运营师跟进

## 配置说明

### 数据库配置
在 `config/config.py` 中配置数据库连接信息：

```python
db_config = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'xpxx1688',
    'database': 'dianping',
    'charset': 'utf8mb4',
}
```

### 输出目录配置
```python
REPORT_OUTPUT_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), 'output')
```

## 依赖要求

确保安装以下Python包：
```bash
pip install sqlalchemy pymysql pandas openpyxl
```

**注意**: 
- `openpyxl` 用于Excel文件的生成和样式设置。如果未安装，脚本仍会生成Excel文件，但会跳过样式设置。
- `matplotlib` 用于图表生成功能，目前已被禁用。如需重新启用图表功能，请取消注释相关代码。

## 数据表要求

脚本需要以下数据库表：

### store_mapping 表
- 门店ID (store_id)
- 美团门店ID
- 推广门店 (brand_name)
- 运营师 (operator)

### operation_data 表
- 美团门店ID
- 日期
- 曝光人数
- 访问人数
- 购买人数
- 消费金额
- 新好评数
- 新中差评数
- 打卡人数
- 扫码人数
- 点评星级
- 新增收藏人数
- rankings_detail

### cpc_hourly_data 表
- store_id
- date
- cost
- impressions
- clicks
- orders

## 测试脚本

使用 `test_daily_report.py` 来测试基本功能：

```bash
python scripts/test_daily_report.py
```

测试内容包括：
- 数据库连接测试
- 门店映射数据获取测试
- 数据可用性检查

## 注意事项

1. **日期格式**: 使用 YYYY-MM-DD 格式
2. **数据依赖**: 确保数据库中有对应日期的数据
3. **权限要求**: 确保数据库用户有读取相关表的权限
4. **输出目录**: 确保output目录存在或有创建权限

## 错误处理

脚本包含完善的错误处理机制：
- 数据库连接失败时会记录错误日志
- 数据缺失时会跳过相应品牌
- 运营师信息缺失时会记录警告

## 扩展功能

可以根据需要扩展以下功能：
- 添加更多指标分析
- 生成Excel格式报告
- 添加图表可视化
- 集成邮件发送功能 