def safe_dumps(obj):
    import json
    return json.dumps(obj, ensure_ascii=False, indent=2, default=str)

def build_ai_prompt(brand_name, brand_profile, op_summary, cpc_summary, comparison_dict, start_date, end_date, factors, cpc_ratios, notes_text):
    import json

    prompt = f"""
你是“{brand_name}”的品牌运营顾问，熟悉品牌调性、用户结构与数据逻辑。同时你非常了解以上海为代表的中国国内餐饮营销情况，可以给出深刻的洞察并设计有趣有效的运营方案。
请你基于下列数据撰写一份【商业理性】风格的运营分析报告，并辅助品牌判断“问题在哪、机会在哪、下步做什么”。

【品牌画像】
{brand_profile.get(brand_name, "暂无品牌画像")}

【运营数据摘要】
{safe_dumps(op_summary)}

【推广通（CPC）数据摘要】
{safe_dumps(cpc_summary)}

【系统测算的 CPC 占比】
{safe_dumps(cpc_ratios)}

【关于推广通数据理解说明】
- 注意：CPC 数据中的“订单量”仅记录“点击广告后立即成交”的部分，真实转化可能被低估；
- 因此建议以“花费 / 订单量”计算“单均获客成本”（此值偏高但稳定），作为推广效益判断依据；
- 若当前月该成本 < 60 元（流杯酒肆客单价约为 300 元+），则推广可以接受；如高于 80 元需警惕无效流量；
- 若订单量缺失或不准确，请合理提示用户补充或评估；
- 请将当前月与上月在 CPC花费、点击、订单量、占比 维度进行对比，并结合客观因素分析原因（如上新/节假日/天气等）。

【分时段洞察建议】
- 当前推广通数据为小时级记录，系统已自动汇总为日/整月数据；
- 结合原始数据，分析重点投放时段与实际成效之间的关系，关注：
  - 是否存在“高花费低转化”时段（建议后续调整投放策略）
  - 是否有“点击密集但订单偏少”时段（用户兴趣高但转化流程可能存在问题）
  - 高转化时段是否为日间/晚间，对应门店的运营时间段是否匹配？
- 如发现明显时段偏差或异常，请尝试优化投放时间或调整素材策略。


【环比变化】
{safe_dumps(comparison_dict)}

【运营期间事件记录】
{factors}

【用户补充说明】
{notes_text}

如字段本身不存在，或原始字段无法组合出结果，才应提示用户补充；否则请尝试推导计算。

---

【请输出结构】
1. 本阶段运营概况（用 3~5 句描述关键变化，定性 + 数据点）
2. 关键问题拆解（从流量结构、转化路径、复购/口碑等角度列出 2~3 个问题）
3. 投放评估（清晰给出 CPC 效率与必要性判断，不重复解释）
4. 机会建议（仅保留与当前问题强相关的建议）
5. 汇报用 TL;DR（用一句话告诉老板“这月干得好不好、为什么、下月要干嘛”）

语气务实简明，避免套话，不赘述不翻译数据。格式为 Markdown，可用列表。

风格务实理性，拒绝空话套话，允许提出假设性判断。
"""
    return prompt
